import pytest
import time
from playwright.sync_api import Page, expect
from page.login_page import LoginPage
from page.dashboard_page import DashboardPage
from page.user_management_page import UserManagementPage
from utils.test_data_manager import test_data_manager
from loguru import logger


class TestUserManagement:
    """用户管理功能测试用例类"""
    
    @pytest.fixture(autouse=True)
    def setup(self, page: Page):
        """测试前置设置"""
        self.login_page = LoginPage(page)
        self.dashboard_page = DashboardPage(page)
        self.user_management_page = UserManagementPage(page)
        
        # 清除存储
        try:
            page.evaluate("localStorage.clear()")
            page.evaluate("sessionStorage.clear()")
        except Exception:
            pass
        
    def login_as_admin(self, page: Page):
        """以管理员身份登录"""
        # 从数据管理器获取管理员用户信息
        admin_user = test_data_manager.get_user_by_username("admin")
        assert admin_user is not None, "未找到管理员用户数据"
        
        self.login_page.navigate()
        self.login_page.login(admin_user.username, admin_user.password)
        
        # 等待登录成功消息出现
        page.wait_for_selector(".alert.alert-success", timeout=5000)
        
        # 获取基础URL配置
        base_url = test_data_manager.get_base_url()
        
        # 验证跳转到仪表板
        expect(page).to_have_url(f"{base_url}/pages/dashboard.html", timeout=15000)
        
    def test_add_duplicate_username(self, page: Page):
        """测试添加重复用户名"""
        self.login_as_admin(page)
        self.user_management_page.navigate()
        
        # 从数据管理器获取重复用户名测试数据
        form_data = test_data_manager.get_test_data("FormData", "test_data.xlsx")
        duplicate_scenario = next((item for item in form_data if item["test_case"] == "duplicate_username"), None)
        assert duplicate_scenario is not None, "未找到重复用户名测试数据"
        
        # 尝试创建重复用户名的用户
        self.user_management_page.create_user(
            duplicate_scenario["name"],
            duplicate_scenario["username"],
            duplicate_scenario["email"],
            duplicate_scenario["password"],
            duplicate_scenario["role"],
            "active"
        )
        
        # 验证错误消息 - 先等待一下让错误消息显示
        page.wait_for_timeout(2000)
        
        # 检查是否有错误消息显示
        error_selectors = [
            ".alert.alert-error",
            ".error-message", 
            "[class*='error']",
            "#userFormMessage .error-message"
        ]
        
        error_found = False
        for selector in error_selectors:
            try:
                if page.locator(selector).is_visible():
                    error_text = page.locator(selector).text_content()
                    logger.info(f"找到错误消息: {error_text}")
                    error_found = True
                    break
            except:
                continue
        
        if not error_found:
            # 如果没找到错误消息，截图并打印页面内容
            page.screenshot(path="debug_error_message.png")
            logger.debug("页面HTML:", page.content()[-1000:])  # 打印最后1000个字符
            
        assert error_found, "应该显示重复用户名的错误消息"
        
    def test_add_new_user_success(self, page: Page):
        """测试成功添加新用户"""
        self.login_as_admin(page)
        self.user_management_page.navigate()
        
        # 从数据管理器获取新用户测试数据
        form_data = test_data_manager.get_test_data("FormData", "test_data.xlsx")
        new_user_scenario = next((item for item in form_data if item["test_case"] == "valid_new_user"), None)
        assert new_user_scenario is not None, "未找到新用户测试数据"
        
        # 生成唯一用户名（避免重复）
        unique_username = f"{new_user_scenario['username']}{int(time.time())}"
        
        # 创建新用户
        self.user_management_page.create_user(
            new_user_scenario["name"],
            unique_username,
            new_user_scenario["email"].replace("newuser1", unique_username),  # 确保邮箱也是唯一的
            new_user_scenario["password"],
            new_user_scenario["role"],
            "active"
        )
        
        # 等待成功消息
        self.user_management_page.wait_for_success_message()
        
        # 验证用户已添加到列表中
        self.user_management_page.verify_user_in_list(unique_username)