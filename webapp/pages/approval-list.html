<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áî≥ËØ∑ÂàóË°® - ÊµãËØïÁ≥ªÁªü</title>
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .page-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }
        
        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .filter-control {
            height: 40px;
            padding: 0 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .approvals-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .approvals-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .approvals-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .approvals-count {
            font-size: 14px;
            color: #666;
        }
        
        .approvals-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .approval-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .approval-item:hover {
            background: #f8f9ff;
        }
        
        .approval-item:last-child {
            border-bottom: none;
        }
        
        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .approval-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 5px 0;
        }
        
        .approval-id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        
        .approval-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .priority-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .priority-badge.high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .priority-badge.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .priority-badge.low {
            background: #d4edda;
            color: #155724;
        }
        
        .approval-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .meta-item {
            font-size: 14px;
        }
        
        .meta-label {
            color: #666;
            font-weight: 500;
        }
        
        .meta-value {
            color: #333;
            font-weight: 600;
        }
        
        .approval-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-top: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-sm {
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .empty-description {
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .page-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .approval-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .approval-meta {
                grid-template-columns: 1fr;
            }
            
            .approval-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="dashboard.html">‰ª™Ë°®Êùø</a>
                <span>></span>
                <span>Áî≥ËØ∑ÂàóË°®</span>
            </div>
            <h1 class="page-title">ÊàëÁöÑÁî≥ËØ∑</h1>
            <div class="page-actions">
                <a href="approval-create.html" class="btn btn-primary">üìù Êèê‰∫§Êñ∞Áî≥ËØ∑</a>
                <button id="refreshBtn" class="btn btn-secondary">üîÑ Âà∑Êñ∞</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Á≠õÈÄâÂô® -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Áî≥ËØ∑Áä∂ÊÄÅ</label>
                    <select id="statusFilter" class="filter-control">
                        <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                        <option value="pending">ÂæÖÂÆ°Êâπ</option>
                        <option value="approved">Â∑≤ÈÄöËøá</option>
                        <option value="rejected">Â∑≤ÊãíÁªù</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Áî≥ËØ∑Á±ªÂûã</label>
                    <select id="typeFilter" class="filter-control">
                        <option value="">ÂÖ®ÈÉ®Á±ªÂûã</option>
                        <option value="leave">ËØ∑ÂÅáÁî≥ËØ∑</option>
                        <option value="expense">Ë¥πÁî®Êä•ÈîÄ</option>
                        <option value="purchase">ÈááË¥≠Áî≥ËØ∑</option>
                        <option value="project">È°πÁõÆÁî≥ËØ∑</option>
                        <option value="other">ÂÖ∂‰ªñÁî≥ËØ∑</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Á¥ßÊÄ•Á®ãÂ∫¶</label>
                    <select id="priorityFilter" class="filter-control">
                        <option value="">ÂÖ®ÈÉ®‰ºòÂÖàÁ∫ß</option>
                        <option value="high">Á¥ßÊÄ•</option>
                        <option value="medium">ÊôÆÈÄö</option>
                        <option value="low">‰∏çÊÄ•</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ÊêúÁ¥¢</label>
                    <input type="text" id="searchFilter" class="filter-control" placeholder="ÊêúÁ¥¢Ê†áÈ¢òÊàñÊèèËø∞...">
                </div>
            </div>
        </div>
        
        <!-- Áî≥ËØ∑ÂàóË°® -->
        <div class="approvals-container">
            <div class="approvals-header">
                <h2 class="approvals-title">Áî≥ËØ∑ÂàóË°®</h2>
                <div class="approvals-count" id="approvalsCount">ÂÖ± 0 Êù°Áî≥ËØ∑</div>
            </div>
            
            <div class="approvals-list" id="approvalsList">
                <!-- Áî≥ËØ∑È°πÁõÆÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
    
    <script src="../js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
            if (!Utils.auth.requireAuth()) {
                return;
            }
            
            const approvalsList = document.getElementById('approvalsList');
            const approvalsCount = document.getElementById('approvalsCount');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const searchFilter = document.getElementById('searchFilter');
            const refreshBtn = document.getElementById('refreshBtn');
            
            let allApprovals = [];
            let filteredApprovals = [];
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑
            const currentUser = Utils.auth.getCurrentUser();
            
            // Âä†ËΩΩÁî≥ËØ∑ÂàóË°®
            function loadApprovals() {
                const approvals = Utils.data.getApprovals();
                // ÁÆ°ÁêÜÂëòÂíåÁªèÁêÜÂèØ‰ª•ÁúãÂà∞ÊâÄÊúâÁî≥ËØ∑ÔºåÊôÆÈÄöÁî®Êà∑Âè™ËÉΩÁúãÂà∞Ëá™Â∑±ÁöÑÁî≥ËØ∑
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    allApprovals = approvals;
                } else {
                    allApprovals = approvals.filter(approval => approval.applicant === currentUser.username);
                }
                applyFilters();
            }
            
            // Â∫îÁî®Á≠õÈÄâÂô®
            function applyFilters() {
                filteredApprovals = allApprovals.filter(approval => {
                    // Áä∂ÊÄÅÁ≠õÈÄâ
                    if (statusFilter.value && approval.status !== statusFilter.value) {
                        return false;
                    }
                    
                    // Á±ªÂûãÁ≠õÈÄâ
                    if (typeFilter.value && approval.type !== typeFilter.value) {
                        return false;
                    }
                    
                    // ‰ºòÂÖàÁ∫ßÁ≠õÈÄâ
                    if (priorityFilter.value && approval.priority !== priorityFilter.value) {
                        return false;
                    }
                    
                    // ÊêúÁ¥¢Á≠õÈÄâ
                    if (searchFilter.value) {
                        const searchTerm = searchFilter.value.toLowerCase();
                        return approval.title.toLowerCase().includes(searchTerm) ||
                               approval.description.toLowerCase().includes(searchTerm);
                    }
                    
                    return true;
                });
                
                renderApprovals();
            }
            
            // Ê∏≤ÊüìÁî≥ËØ∑ÂàóË°®
            function renderApprovals() {
                approvalsCount.textContent = `ÂÖ± ${filteredApprovals.length} Êù°Áî≥ËØ∑`;
                
                if (filteredApprovals.length === 0) {
                    approvalsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">ÊöÇÊó†Áî≥ËØ∑ËÆ∞ÂΩï</div>
                            <div class="empty-description">ÊÇ®ËøòÊ≤°ÊúâÊèê‰∫§‰ªª‰ΩïÁî≥ËØ∑ÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÂàõÂª∫Êñ∞Áî≥ËØ∑</div>
                            <a href="approval-create.html" class="btn btn-primary">Êèê‰∫§Êñ∞Áî≥ËØ∑</a>
                        </div>
                    `;
                    return;
                }
                
                approvalsList.innerHTML = filteredApprovals.map(approval => {
                    const statusText = {
                        'pending': 'ÂæÖÂÆ°Êâπ',
                        'approved': 'Â∑≤ÈÄöËøá',
                        'rejected': 'Â∑≤ÊãíÁªù'
                    }[approval.status] || approval.status;
                    
                    const typeText = {
                        'leave': 'ËØ∑ÂÅáÁî≥ËØ∑',
                        'expense': 'Ë¥πÁî®Êä•ÈîÄ',
                        'purchase': 'ÈááË¥≠Áî≥ËØ∑',
                        'project': 'È°πÁõÆÁî≥ËØ∑',
                        'other': 'ÂÖ∂‰ªñÁî≥ËØ∑'
                    }[approval.type] || approval.type;
                    
                    const priorityText = {
                        'high': 'üî¥ Á¥ßÊÄ•',
                        'medium': 'üü° ÊôÆÈÄö',
                        'low': 'üü¢ ‰∏çÊÄ•'
                    }[approval.priority] || approval.priority;
                    
                    const createdDate = new Date(approval.createdAt).toLocaleString('zh-CN');
                    const updatedDate = new Date(approval.updatedAt).toLocaleString('zh-CN');
                    
                    return `
                        <div class="approval-item" onclick="viewApproval('${approval.id}')">
                            <div class="approval-header">
                                <div>
                                    <h3 class="approval-title">${approval.title}</h3>
                                    <div class="approval-id">ID: ${approval.id}</div>
                                </div>
                                <div class="approval-status">
                                    <span class="status-badge ${approval.status}">${statusText}</span>
                                    <span class="priority-badge ${approval.priority}">${priorityText}</span>
                                </div>
                            </div>
                            
                            <div class="approval-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Á±ªÂûãÔºö</span>
                                    <span class="meta-value">${typeText}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Êèê‰∫§Êó∂Èó¥Ôºö</span>
                                    <span class="meta-value">${createdDate}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Êõ¥Êñ∞Êó∂Èó¥Ôºö</span>
                                    <span class="meta-value">${updatedDate}</span>
                                </div>
                                ${approval.amount ? `
                                <div class="meta-item">
                                    <span class="meta-label">ÈáëÈ¢ùÔºö</span>
                                    <span class="meta-value">¬•${approval.amount.toFixed(2)}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="approval-description">${approval.description}</div>
                            
                            <div class="approval-actions">
                                <button class="btn-sm btn-primary" onclick="event.stopPropagation(); viewApproval('${approval.id}')">Êü•ÁúãËØ¶ÊÉÖ</button>
                                ${approval.status === 'pending' ? `
                                    <button class="btn-sm btn-secondary" onclick="event.stopPropagation(); editApproval('${approval.id}')">ÁºñËæë</button>
                                    <button class="btn-sm btn-danger" onclick="event.stopPropagation(); cancelApproval('${approval.id}')">Êí§ÈîÄ</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Êü•ÁúãÁî≥ËØ∑ËØ¶ÊÉÖ
            window.viewApproval = function(id) {
                window.location.href = `approval-detail.html?id=${id}`;
            };
            
            // ÁºñËæëÁî≥ËØ∑
            window.editApproval = function(id) {
                window.location.href = `approval-edit.html?id=${id}`;
            };
            
            // Êí§ÈîÄÁî≥ËØ∑
            window.cancelApproval = function(id) {
                if (confirm('Á°ÆÂÆöË¶ÅÊí§ÈîÄËøô‰∏™Áî≥ËØ∑ÂêóÔºüÊí§ÈîÄÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ')) {
                    try {
                        Utils.data.deleteApproval(id);
                        Utils.ui.showMessage('Áî≥ËØ∑Â∑≤Êí§ÈîÄ', 'success');
                        loadApprovals();
                    } catch (error) {
                        Utils.ui.showMessage('Êí§ÈîÄÂ§±Ë¥•Ôºö' + error.message, 'error');
                    }
                }
            };
            
            // ÁªëÂÆöÁ≠õÈÄâÂô®‰∫ã‰ª∂
            statusFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            priorityFilter.addEventListener('change', applyFilters);
            searchFilter.addEventListener('input', applyFilters);
            
            // Âà∑Êñ∞ÊåâÈíÆ
            refreshBtn.addEventListener('click', function() {
                loadApprovals();
                Utils.ui.showMessage('ÂàóË°®Â∑≤Âà∑Êñ∞', 'success');
            });
            
            // ÂàùÂßãÂä†ËΩΩ
            loadApprovals();
        });
    </script>
</body>
</html>