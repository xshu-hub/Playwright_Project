<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”³è¯·åˆ—è¡¨ - æµ‹è¯•ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .page-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }
        
        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .filter-control {
            height: 40px;
            padding: 0 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .approvals-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .approvals-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .approvals-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .approvals-count {
            font-size: 14px;
            color: #666;
        }
        
        .approvals-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .approval-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .approval-item:hover {
            background: #f8f9ff;
        }
        
        .approval-item:last-child {
            border-bottom: none;
        }
        
        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .approval-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 5px 0;
        }
        
        .approval-id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        
        .approval-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .priority-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .priority-badge.high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .priority-badge.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .priority-badge.low {
            background: #d4edda;
            color: #155724;
        }
        
        .approval-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .meta-item {
            font-size: 14px;
        }
        
        .meta-label {
            color: #666;
            font-weight: 500;
        }
        
        .meta-value {
            color: #333;
            font-weight: 600;
        }
        
        .approval-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-top: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .approval-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-sm {
            padding: 6px 16px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .empty-description {
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .page-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .approval-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .approval-meta {
                grid-template-columns: 1fr;
            }
            
            .approval-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="dashboard.html">ä»ªè¡¨æ¿</a>
                <span>></span>
                <span>ç”³è¯·åˆ—è¡¨</span>
            </div>
            <h1 class="page-title">æˆ‘çš„ç”³è¯·</h1>
            <div class="page-actions">
                <a href="approval-create.html" class="btn btn-primary">ğŸ“ æäº¤æ–°ç”³è¯·</a>
                <button id="refreshBtn" class="btn btn-secondary">ğŸ”„ åˆ·æ–°</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- ç­›é€‰å™¨ -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">ç”³è¯·çŠ¶æ€</label>
                    <select id="statusFilter" class="filter-control">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="pending">å¾…å®¡æ‰¹</option>
                        <option value="approved">å·²é€šè¿‡</option>
                        <option value="rejected">å·²æ‹’ç»</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ç”³è¯·ç±»å‹</label>
                    <select id="typeFilter" class="filter-control">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="leave">è¯·å‡ç”³è¯·</option>
                        <option value="expense">è´¹ç”¨æŠ¥é”€</option>
                        <option value="purchase">é‡‡è´­ç”³è¯·</option>
                        <option value="project">é¡¹ç›®ç”³è¯·</option>
                        <option value="other">å…¶ä»–ç”³è¯·</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">ç´§æ€¥ç¨‹åº¦</label>
                    <select id="priorityFilter" class="filter-control">
                        <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                        <option value="high">ç´§æ€¥</option>
                        <option value="medium">æ™®é€š</option>
                        <option value="low">ä¸æ€¥</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">æœç´¢</label>
                    <input type="text" id="searchFilter" class="filter-control" placeholder="æœç´¢æ ‡é¢˜æˆ–æè¿°...">
                </div>
            </div>
        </div>
        
        <!-- ç”³è¯·åˆ—è¡¨ -->
        <div class="approvals-container">
            <div class="approvals-header">
                <h2 class="approvals-title">ç”³è¯·åˆ—è¡¨</h2>
                <div class="approvals-count" id="approvalsCount">å…± 0 æ¡ç”³è¯·</div>
            </div>
            
            <div class="approvals-list" id="approvalsList">
                <!-- ç”³è¯·é¡¹ç›®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <script src="../js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!Utils.auth.requireAuth()) {
                return;
            }
            
            const approvalsList = document.getElementById('approvalsList');
            const approvalsCount = document.getElementById('approvalsCount');
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            const searchFilter = document.getElementById('searchFilter');
            const refreshBtn = document.getElementById('refreshBtn');
            
            let allApprovals = [];
            let filteredApprovals = [];
            
            // è·å–å½“å‰ç”¨æˆ·
            const currentUser = Utils.auth.getCurrentUser();
            
            // åŠ è½½ç”³è¯·åˆ—è¡¨
            function loadApprovals() {
                const approvals = Utils.data.getApprovals();
                // ç®¡ç†å‘˜å’Œç»ç†å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”³è¯·ï¼Œæ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„ç”³è¯·
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    allApprovals = approvals;
                } else {
                    allApprovals = approvals.filter(approval => approval.applicant === currentUser.username);
                }
                applyFilters();
            }
            
            // åº”ç”¨ç­›é€‰å™¨
            function applyFilters() {
                filteredApprovals = allApprovals.filter(approval => {
                    // çŠ¶æ€ç­›é€‰
                    if (statusFilter.value && approval.status !== statusFilter.value) {
                        return false;
                    }
                    
                    // ç±»å‹ç­›é€‰
                    if (typeFilter.value && approval.type !== typeFilter.value) {
                        return false;
                    }
                    
                    // ä¼˜å…ˆçº§ç­›é€‰
                    if (priorityFilter.value && approval.priority !== priorityFilter.value) {
                        return false;
                    }
                    
                    // æœç´¢ç­›é€‰
                    if (searchFilter.value) {
                        const searchTerm = searchFilter.value.toLowerCase();
                        return approval.title.toLowerCase().includes(searchTerm) ||
                               approval.description.toLowerCase().includes(searchTerm);
                    }
                    
                    return true;
                });
                
                renderApprovals();
            }
            
            // æ¸²æŸ“ç”³è¯·åˆ—è¡¨
            function renderApprovals() {
                approvalsCount.textContent = `å…± ${filteredApprovals.length} æ¡ç”³è¯·`;
                
                if (filteredApprovals.length === 0) {
                    approvalsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div class="empty-title">æš‚æ— ç”³è¯·è®°å½•</div>
                            <div class="empty-description">æ‚¨è¿˜æ²¡æœ‰æäº¤ä»»ä½•ç”³è¯·ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæ–°ç”³è¯·</div>
                            <a href="approval-create.html" class="btn btn-primary">æäº¤æ–°ç”³è¯·</a>
                        </div>
                    `;
                    return;
                }
                
                approvalsList.innerHTML = filteredApprovals.map(approval => {
                    const statusText = {
                        'pending': 'å¾…å®¡æ‰¹',
                        'approved': 'å·²é€šè¿‡',
                        'rejected': 'å·²æ‹’ç»'
                    }[approval.status] || approval.status;
                    
                    const typeText = {
                        'leave': 'è¯·å‡ç”³è¯·',
                        'expense': 'è´¹ç”¨æŠ¥é”€',
                        'purchase': 'é‡‡è´­ç”³è¯·',
                        'project': 'é¡¹ç›®ç”³è¯·',
                        'other': 'å…¶ä»–ç”³è¯·'
                    }[approval.type] || approval.type;
                    
                    const priorityText = {
                        'high': 'ğŸ”´ ç´§æ€¥',
                        'medium': 'ğŸŸ¡ æ™®é€š',
                        'low': 'ğŸŸ¢ ä¸æ€¥'
                    }[approval.priority] || approval.priority;
                    
                    const createdDate = new Date(approval.createdAt).toLocaleString('zh-CN');
                    const updatedDate = new Date(approval.updatedAt).toLocaleString('zh-CN');
                    
                    return `
                        <div class="approval-item" onclick="viewApproval('${approval.id}')">
                            <div class="approval-header">
                                <div>
                                    <h3 class="approval-title">${approval.title}</h3>
                                    <div class="approval-id">ID: ${approval.id}</div>
                                </div>
                                <div class="approval-status">
                                    <span class="status-badge ${approval.status}">${statusText}</span>
                                    <span class="priority-badge ${approval.priority}">${priorityText}</span>
                                </div>
                            </div>
                            
                            <div class="approval-meta">
                                <div class="meta-item">
                                    <span class="meta-label">ç±»å‹ï¼š</span>
                                    <span class="meta-value">${typeText}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">æäº¤æ—¶é—´ï¼š</span>
                                    <span class="meta-value">${createdDate}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">æ›´æ–°æ—¶é—´ï¼š</span>
                                    <span class="meta-value">${updatedDate}</span>
                                </div>
                                ${approval.amount ? `
                                <div class="meta-item">
                                    <span class="meta-label">é‡‘é¢ï¼š</span>
                                    <span class="meta-value">Â¥${approval.amount.toFixed(2)}</span>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="approval-description">${approval.description}</div>
                            
                            <div class="approval-actions">
                                <button class="btn-sm btn-primary" onclick="event.stopPropagation(); viewApproval('${approval.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                                ${approval.status === 'pending' ? `
                                    <button class="btn-sm btn-secondary" onclick="event.stopPropagation(); editApproval('${approval.id}')">ç¼–è¾‘</button>
                                    <button class="btn-sm btn-danger" onclick="event.stopPropagation(); cancelApproval('${approval.id}')">æ’¤é”€</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // æŸ¥çœ‹ç”³è¯·è¯¦æƒ…
            window.viewApproval = function(id) {
                window.location.href = `approval-detail.html?id=${id}`;
            };
            
            // ç¼–è¾‘ç”³è¯·
            window.editApproval = function(id) {
                window.location.href = `approval-edit.html?id=${id}`;
            };
            
            // æ’¤é”€ç”³è¯·
            window.cancelApproval = function(id) {
                if (confirm('ç¡®å®šè¦æ’¤é”€è¿™ä¸ªç”³è¯·å—ï¼Ÿæ’¤é”€åå°†æ— æ³•æ¢å¤ã€‚')) {
                    try {
                        Utils.data.deleteApproval(id);
                        Utils.ui.showMessage('ç”³è¯·å·²æ’¤é”€', 'success');
                        loadApprovals();
                    } catch (error) {
                        Utils.ui.showMessage('æ’¤é”€å¤±è´¥ï¼š' + error.message, 'error');
                    }
                }
            };
            
            // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
            statusFilter.addEventListener('change', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            priorityFilter.addEventListener('change', applyFilters);
            searchFilter.addEventListener('input', applyFilters);
            
            // åˆ·æ–°æŒ‰é’®
            refreshBtn.addEventListener('click', function() {
                loadApprovals();
                Utils.ui.showMessage('åˆ—è¡¨å·²åˆ·æ–°', 'success');
            });
            
            // åˆå§‹åŠ è½½
            loadApprovals();
        });
    </script>
</body>
</html>