<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æäº¤ç”³è¯· - æµ‹è¯•ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-control {
            height: 45px;
            padding: 0 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.form-control {
            height: 120px;
            padding: 15px;
            resize: vertical;
            font-family: inherit;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            color: #155724;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #d4edda;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
        }
        
        .required {
            color: #dc3545;
        }
        
        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .priority-option {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .priority-option:hover {
            border-color: #667eea;
        }
        
        .priority-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .priority-option.high {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .priority-option.high.selected {
            background: #f8d7da;
        }
        
        .priority-option.medium {
            border-color: #ffc107;
            color: #ffc107;
        }
        
        .priority-option.medium.selected {
            background: #fff3cd;
        }
        
        .priority-option.low {
            border-color: #28a745;
            color: #28a745;
        }
        
        .priority-option.low.selected {
            background: #d4edda;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .priority-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="dashboard.html">ä»ªè¡¨æ¿</a>
                <span>></span>
                <span>æäº¤ç”³è¯·</span>
            </div>
            <h1 class="page-title">æäº¤æ–°ç”³è¯·</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="form-container">
            <form id="approvalForm">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span>ğŸ“‹</span>
                        åŸºæœ¬ä¿¡æ¯
                    </h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ç”³è¯·æ ‡é¢˜ <span class="required">*</span></label>
                            <input type="text" id="title" class="form-control" placeholder="è¯·è¾“å…¥ç”³è¯·æ ‡é¢˜" required>
                            <div class="form-help">ç®€æ´æ˜äº†åœ°æè¿°æ‚¨çš„ç”³è¯·å†…å®¹</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ç”³è¯·ç±»å‹ <span class="required">*</span></label>
                            <select id="type" class="form-control" required>
                                <option value="">è¯·é€‰æ‹©ç”³è¯·ç±»å‹</option>
                                <option value="leave">è¯·å‡ç”³è¯·</option>
                                <option value="expense">è´¹ç”¨æŠ¥é”€</option>
                                <option value="purchase">é‡‡è´­ç”³è¯·</option>
                                <option value="project">é¡¹ç›®ç”³è¯·</option>
                                <option value="other">å…¶ä»–ç”³è¯·</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">ç”³è¯·æè¿° <span class="required">*</span></label>
                            <textarea id="description" class="form-control" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„ç”³è¯·å†…å®¹ã€åŸå› å’Œé¢„æœŸç»“æœ" required></textarea>
                            <div class="form-help">è¯·æä¾›è¶³å¤Ÿçš„è¯¦ç»†ä¿¡æ¯ä»¥ä¾¿å®¡æ‰¹äººå‘˜äº†è§£æ‚¨çš„ç”³è¯·</div>
                        </div>
                    </div>
                </div>
                
                <!-- ç”³è¯·è¯¦æƒ… -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span>âš™ï¸</span>
                        ç”³è¯·è¯¦æƒ…
                    </h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é¢„æœŸå¼€å§‹æ—¶é—´</label>
                            <input type="datetime-local" id="startTime" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">é¢„æœŸç»“æŸæ—¶é—´</label>
                            <input type="datetime-local" id="endTime" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">æ¶‰åŠé‡‘é¢ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="amount" class="form-control" placeholder="0.00" step="0.01" min="0">
                            <div class="form-help">å¦‚æœç”³è¯·æ¶‰åŠè´¹ç”¨ï¼Œè¯·å¡«å†™å…·ä½“é‡‘é¢</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ç´§æ€¥ç¨‹åº¦ <span class="required">*</span></label>
                            <div class="priority-selector">
                                <div class="priority-option high" data-priority="high">
                                    <div>ğŸ”´ ç´§æ€¥</div>
                                    <small>éœ€è¦ç«‹å³å¤„ç†</small>
                                </div>
                                <div class="priority-option medium selected" data-priority="medium">
                                    <div>ğŸŸ¡ æ™®é€š</div>
                                    <small>æ­£å¸¸å¤„ç†æ—¶é—´</small>
                                </div>
                                <div class="priority-option low" data-priority="low">
                                    <div>ğŸŸ¢ ä¸æ€¥</div>
                                    <small>å¯ä»¥å»¶åå¤„ç†</small>
                                </div>
                            </div>
                            <input type="hidden" id="priority" value="medium">
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">å¤‡æ³¨ä¿¡æ¯</label>
                            <textarea id="remarks" class="form-control" placeholder="å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- æäº¤æŒ‰é’® -->
                <div class="form-section">
                    <div id="messageContainer"></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">æäº¤ç”³è¯·</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script src="../js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!Utils.auth.requireAuth()) {
                return;
            }
            
            const form = document.getElementById('approvalForm');
            const priorityOptions = document.querySelectorAll('.priority-option');
            const priorityInput = document.getElementById('priority');
            const messageContainer = document.getElementById('messageContainer');
            
            // ä¼˜å…ˆçº§é€‰æ‹©
            priorityOptions.forEach(option => {
                option.addEventListener('click', function() {
                    priorityOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    priorityInput.value = this.dataset.priority;
                });
            });
            
            // è¡¨å•æäº¤
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // æ¸…é™¤ä¹‹å‰çš„æ¶ˆæ¯
                messageContainer.innerHTML = '';
                
                try {
                    // è·å–è¡¨å•æ•°æ®
                    const formData = {
                        title: document.getElementById('title').value.trim(),
                        type: document.getElementById('type').value,
                        description: document.getElementById('description').value.trim(),
                        startTime: document.getElementById('startTime').value,
                        endTime: document.getElementById('endTime').value,
                        amount: document.getElementById('amount').value,
                        priority: document.getElementById('priority').value,
                        remarks: document.getElementById('remarks').value.trim()
                    };
                    
                    // éªŒè¯å¿…å¡«å­—æ®µ
                    Utils.validation.required(formData.title, 'ç”³è¯·æ ‡é¢˜');
                    Utils.validation.required(formData.type, 'ç”³è¯·ç±»å‹');
                    Utils.validation.required(formData.description, 'ç”³è¯·æè¿°');
                    
                    // éªŒè¯æ—¶é—´é€»è¾‘
                    if (formData.startTime && formData.endTime) {
                        const startDate = new Date(formData.startTime);
                        const endDate = new Date(formData.endTime);
                        
                        if (endDate <= startDate) {
                            throw new Error('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
                        }
                    }
                    
                    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                    const currentUser = Utils.auth.getCurrentUser();
                    
                    // æ„å»ºç”³è¯·å¯¹è±¡
                    const approval = {
                        title: formData.title,
                        type: formData.type,
                        description: formData.description,
                        startTime: formData.startTime,
                        endTime: formData.endTime,
                        amount: formData.amount ? parseFloat(formData.amount) : null,
                        priority: formData.priority,
                        remarks: formData.remarks,
                        applicant: currentUser.username,
                        applicantName: currentUser.name,
                        applicantEmail: currentUser.email
                    };
                    
                    // ä¿å­˜ç”³è¯·
                    const savedApproval = Utils.data.addApproval(approval);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    messageContainer.innerHTML = `
                        <div class="success-message">
                            âœ… ç”³è¯·æäº¤æˆåŠŸï¼ç”³è¯·ç¼–å·ï¼š${savedApproval.id}
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºå…¨å±€æˆåŠŸæ¶ˆæ¯
                    Utils.ui.showMessage('ç”³è¯·æäº¤æˆåŠŸï¼', 'success');
                    
                    // å»¶è¿Ÿè·³è½¬åˆ°ç”³è¯·åˆ—è¡¨é¡µé¢
                    setTimeout(() => {
                        window.location.href = 'approval-list.html';
                    }, 2000);
                    
                } catch (error) {
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    messageContainer.innerHTML = `
                        <div class="error-message">
                            âŒ ${error.message}
                        </div>
                    `;
                    
                    // æ»šåŠ¨åˆ°é”™è¯¯æ¶ˆæ¯
                    messageContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            // è®¾ç½®é»˜è®¤çš„å¼€å§‹æ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            const currentDateTime = now.toISOString().slice(0, 16);
            document.getElementById('startTime').value = currentDateTime;
            
            // è®¾ç½®é»˜è®¤çš„ç»“æŸæ—¶é—´ä¸º1å°æ—¶å
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            const oneHourLaterDateTime = oneHourLater.toISOString().slice(0, 16);
            document.getElementById('endTime').value = oneHourLaterDateTime;
        });
    </script>
</body>
</html>