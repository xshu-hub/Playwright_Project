<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提交申请 - 测试系统</title>
    <link rel="stylesheet" href="../css/common.css">
    <style>
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-control {
            height: 45px;
            padding: 0 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.form-control {
            height: 120px;
            padding: 15px;
            resize: vertical;
            font-family: inherit;
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .btn {
            padding: 12px 30px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #f8d7da;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            color: #155724;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background: #d4edda;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
        }
        
        .required {
            color: #dc3545;
        }
        
        .form-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .priority-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .priority-option {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .priority-option:hover {
            border-color: #667eea;
        }
        
        .priority-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .priority-option.high {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .priority-option.high.selected {
            background: #f8d7da;
        }
        
        .priority-option.medium {
            border-color: #ffc107;
            color: #ffc107;
        }
        
        .priority-option.medium.selected {
            background: #fff3cd;
        }
        
        .priority-option.low {
            border-color: #28a745;
            color: #28a745;
        }
        
        .priority-option.low.selected {
            background: #d4edda;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .priority-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="dashboard.html">仪表板</a>
                <span>></span>
                <span>提交申请</span>
            </div>
            <h1 class="page-title">提交新申请</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="form-container">
            <form id="approvalForm">
                <!-- 基本信息 -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span>📋</span>
                        基本信息
                    </h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">申请标题 <span class="required">*</span></label>
                            <input type="text" id="title" class="form-control" placeholder="请输入申请标题" required>
                            <div class="form-help">简洁明了地描述您的申请内容</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">申请类型 <span class="required">*</span></label>
                            <select id="type" class="form-control" required>
                                <option value="">请选择申请类型</option>
                                <option value="leave">请假申请</option>
                                <option value="expense">费用报销</option>
                                <option value="purchase">采购申请</option>
                                <option value="project">项目申请</option>
                                <option value="other">其他申请</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">申请描述 <span class="required">*</span></label>
                            <textarea id="description" class="form-control" placeholder="请详细描述您的申请内容、原因和预期结果" required></textarea>
                            <div class="form-help">请提供足够的详细信息以便审批人员了解您的申请</div>
                        </div>
                    </div>
                </div>
                
                <!-- 申请详情 -->
                <div class="form-section">
                    <h2 class="section-title">
                        <span>⚙️</span>
                        申请详情
                    </h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">预期开始时间</label>
                            <input type="datetime-local" id="startTime" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">预期结束时间</label>
                            <input type="datetime-local" id="endTime" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">涉及金额（元）</label>
                            <input type="number" id="amount" class="form-control" placeholder="0.00" step="0.01" min="0">
                            <div class="form-help">如果申请涉及费用，请填写具体金额</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">紧急程度 <span class="required">*</span></label>
                            <div class="priority-selector">
                                <div class="priority-option high" data-priority="high">
                                    <div>🔴 紧急</div>
                                    <small>需要立即处理</small>
                                </div>
                                <div class="priority-option medium selected" data-priority="medium">
                                    <div>🟡 普通</div>
                                    <small>正常处理时间</small>
                                </div>
                                <div class="priority-option low" data-priority="low">
                                    <div>🟢 不急</div>
                                    <small>可以延后处理</small>
                                </div>
                            </div>
                            <input type="hidden" id="priority" value="medium">
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">备注信息</label>
                            <textarea id="remarks" class="form-control" placeholder="其他需要说明的信息（可选）"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- 提交按钮 -->
                <div class="form-section">
                    <div id="messageContainer"></div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">取消</button>
                        <button type="submit" class="btn btn-primary">提交申请</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script src="../js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 检查登录状态
            if (!Utils.auth.requireAuth()) {
                return;
            }
            
            const form = document.getElementById('approvalForm');
            const priorityOptions = document.querySelectorAll('.priority-option');
            const priorityInput = document.getElementById('priority');
            const messageContainer = document.getElementById('messageContainer');
            
            // 优先级选择
            priorityOptions.forEach(option => {
                option.addEventListener('click', function() {
                    priorityOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    priorityInput.value = this.dataset.priority;
                });
            });
            
            // 表单提交
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 清除之前的消息
                messageContainer.innerHTML = '';
                
                try {
                    // 获取表单数据
                    const formData = {
                        title: document.getElementById('title').value.trim(),
                        type: document.getElementById('type').value,
                        description: document.getElementById('description').value.trim(),
                        startTime: document.getElementById('startTime').value,
                        endTime: document.getElementById('endTime').value,
                        amount: document.getElementById('amount').value,
                        priority: document.getElementById('priority').value,
                        remarks: document.getElementById('remarks').value.trim()
                    };
                    
                    // 验证必填字段
                    Utils.validation.required(formData.title, '申请标题');
                    Utils.validation.required(formData.type, '申请类型');
                    Utils.validation.required(formData.description, '申请描述');
                    
                    // 验证时间逻辑
                    if (formData.startTime && formData.endTime) {
                        const startDate = new Date(formData.startTime);
                        const endDate = new Date(formData.endTime);
                        
                        if (endDate <= startDate) {
                            throw new Error('结束时间必须晚于开始时间');
                        }
                    }
                    
                    // 获取当前用户信息
                    const currentUser = Utils.auth.getCurrentUser();
                    
                    // 构建申请对象
                    const approval = {
                        title: formData.title,
                        type: formData.type,
                        description: formData.description,
                        startTime: formData.startTime,
                        endTime: formData.endTime,
                        amount: formData.amount ? parseFloat(formData.amount) : null,
                        priority: formData.priority,
                        remarks: formData.remarks,
                        applicant: currentUser.username,
                        applicantName: currentUser.name,
                        applicantEmail: currentUser.email
                    };
                    
                    // 保存申请
                    const savedApproval = Utils.data.addApproval(approval);
                    
                    // 显示成功消息
                    messageContainer.innerHTML = `
                        <div class="success-message">
                            ✅ 申请提交成功！申请编号：${savedApproval.id}
                        </div>
                    `;
                    
                    // 显示全局成功消息
                    Utils.ui.showMessage('申请提交成功！', 'success');
                    
                    // 延迟跳转到申请列表页面
                    setTimeout(() => {
                        window.location.href = 'approval-list.html';
                    }, 2000);
                    
                } catch (error) {
                    // 显示错误消息
                    messageContainer.innerHTML = `
                        <div class="error-message">
                            ❌ ${error.message}
                        </div>
                    `;
                    
                    // 滚动到错误消息
                    messageContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            // 设置默认的开始时间为当前时间
            const now = new Date();
            const currentDateTime = now.toISOString().slice(0, 16);
            document.getElementById('startTime').value = currentDateTime;
            
            // 设置默认的结束时间为1小时后
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            const oneHourLaterDateTime = oneHourLater.toISOString().slice(0, 16);
            document.getElementById('endTime').value = oneHourLaterDateTime;
        });
    </script>
</body>
</html>